## Поддержка AVRO

Внешняя компонента может формировать файлы в бинарном формате **AVRO**, который поддерживает передачу данных по схемам, которые записываются в заголовок файла формата **AVRO** при его создании.

### Оглавление

| Метод | Описание |
|-------|----------|
| [СохранитьСхемуAVRO](#формирование-сообщения-в-формате-avro) | Сохранение схемы AVRO |
| [ПреобразоватьВФорматAVRO](#формирование-avro-из-json) | Преобразование JSON в формат AVRO |
| [ОтправитьСообщениеAVRO](#асинхронная-отправка) | Асинхронная отправка AVRO в Kafka |
| [ОтправитьСообщениеAVROСОжиданиемРезультата](#синхронная-отправка) | Синхронная отправка AVRO в Kafka |
| [СохранитьФайлAVRO](#сохранение-данных-в-формате-avro-в-файл) | Сохранение AVRO в файл |
| [ДекодироватьСообщениеAVRO](#декодирование-avro-сообщения) | Декодирование AVRO в JSON или двоичные данные |

---

### Формирование сообщения в формате AVRO
Сохранение схемы, которая будет использоваться для **AVRO**.
```1С
СохранитьСхемуAVRO(ИмяСхемыJSON, СхемаJSON);
```

**ИмяСхемыJSON** - Строка. Обязательный. Имя схемы.

**СхемаJSON** - Строка. Обязательный. Схема, по которой формируются данные (см. параметр **ДанныеJSON** процедуры **ПреобразоватьВФорматAVRO**). Схема должна быть представлена в следующем виде:
```json
{
  "type": "record",
  "name": "user",
  "fields": [
    {
      "name": "id",
      "type": "string"
    },
    {
      "name": "name",
      "type": "string"
    },
    {
      "name": "phone",
      "type": [
        "null",
        "string"
      ]
    }
   ]
}
```
**Возвращает** значение типа булево - "Истина", если операция выполнена успешно.
"Ложь", если была ошибка. 
Текст ошибки можно получить функцией **ПолучитьСообщениеОбОшибке**.

Пример использования метода **СохранитьСхемуAVRO**:
```1С
ИмяСхемыJSON = "user";

СхемаJSON = "{
|  ""type"": ""record"",
|  ""name"": ""user"",
|  ""fields"": [
|    {
|      ""name"": ""id"",
|      ""type"": ""string""
|    },
|    {
|      ""name"": ""name"",
|      ""type"": ""string""
|    },
|    {
|      ""name"": ""phone"",
|      ""type"": [
|        ""null"",
|        ""string""
|      ]
|    }
|   ]
|}";

Результат = Компонента.СохранитьСхемуAVRO(
  ИмяСхемыJSON,
  СхемаJSON
);
	
Если Не Результат Тогда
  ВызватьИсключение Компонента.ПолучитьСообщениеОбОшибке();
КонецЕсли;
```

### Формирование **AVRO** из JSON
```1С
ПреобразоватьВФорматAVRO(ДанныеJSON, ИмяСхемыJSON);
``` 

**ДанныеJSON** - Строка. Обязательный. Данные в формате **JSON**, представленные в следующем виде:
```json
{
  "id":    ["1", "2", "3"],
  "name":  ["Ivan", "Maksim", "Vitaly"],
  "phone": ["+79115672342", null, "+79185172317"],
  "age":   [null, 45, 25] 
}
``` 

Такой массив определяет 3 объекта:
```json
[
  {
    "id":    "1",
    "name":  "Vasiliy",
    "phone": "+79115672342",
    "age":   null
  },
  {
    "id":    "2",
    "name":  "Maksim",
    "phone": null,
    "age":   45
  },
  {
    "id":    "3",
    "name":  "Vitaly",
    "phone": "+79185172317",
    "age":   25
  }
]
``` 

Пример использования метода **ПреобразоватьВФорматAVRO**:
```1С
ДанныеJSON = "{
|  ""id"":    [""1"", ""2"", ""3""],
|  ""name"":  [""Ivan"", ""Maksim"", ""Vitaly""],
|  ""phone"": [""+79115672342"", null, ""+79185172317""],
|  ""age"":   [null, 45, 25] 
|}";

ИмяСхемыJSON = "user";

Результат = Компонента.ПреобразоватьВФорматAVRO(
  ДанныеJSON,
  ИмяСхемыJSON
);
	
Если Не Результат Тогда
  ВызватьИсключение Компонента.ПолучитьСообщениеОбОшибке();
КонецЕсли;
```

**<span style="color: blue">Обратите внимание, </span>** что:
* в каждом поле должен быть массив с одинаковым количеством элементов;
* поля должны быть перечислены строго в той последовательности, в которой определены в схеме (описание схемы далее);
* поддерживаются следующие типы: AVRO_STRING, AVRO_LONG, AVRO_INT, AVRO_FLOAT, AVRO_DOUBLE, AVRO_BOOL, AVRO_NULL, AVRO_UNION, AVRO_FIXED, AVRO_BYTES;
* поддерживается логический тип **UUID** (передаётся как строка в формате `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`).

**ИмяСхемыJSON** - Строка. Обязательный. Имя схемы, которая ранее был сохранена процедурой **СохранитьСхемуAVRO**

**Возвращает** значение типа булево - "Истина", если операция выполнена успешно.
"Ложь", если была ошибка.
Текст ошибки можно получить функцией **ПолучитьСообщениеОбОшибке**.

### Пример использования UUID

Схема с полем UUID:
```json
{
  "type": "record",
  "name": "document",
  "fields": [
    {
      "name": "id",
      "type": {
        "type": "string",
        "logicalType": "uuid"
      }
    },
    {
      "name": "title",
      "type": "string"
    },
    {
      "name": "author_id",
      "type": [
        "null",
        {
          "type": "string",
          "logicalType": "uuid"
        }
      ]
    }
  ]
}
```

Данные с UUID:
```json
{
  "id":        ["550e8400-e29b-41d4-a716-446655440000", "6ba7b810-9dad-11d1-80b4-00c04fd430c8"],
  "title":     ["Документ 1", "Документ 2"],
  "author_id": ["123e4567-e89b-12d3-a456-426614174000", null]
}
```

### Отправка данных в формате AVRO в Kafka

В случае успешного формирования файла **AVRO** данные можно отправить в соответствующий топик в **Kafka** при помощи методов.

### Асинхронная отправка

Для **асинхронной** отправки сообщения необходимо использовать метод **ОтправитьСообщениеAVRO**. Возвращаемое значение аналогично методу **ОтправитьСообщение**.

**Топик** - Строка.

**Партиция** - Число. Если не указано значение, то по умолчанию запись производится в 0 раздел.

**Ключ** - Строка. Необязательный параметр. Ключ сообщения, который может использоваться в темах с уплотнением сообщений по ключу.

**Заголовки** - Строка. Перечень заголовков, состоящих из ключа и значения в следующем формате "ключ1,значение1;ключ2,значение2"



Пример использования метода **ОтправитьСообщениеAVRO**:
```1С
Топик = "USER";

Результат = Компонента.ОтправитьСообщениеAVRO(
  Топик,
  ,
  "key"
);
	
Если Результат == -1 Тогда
  ВызватьИсключение Компонента.ПолучитьСообщениеОбОшибке();
КонецЕсли;
```


#### Синхронная отправка

Для **синхронной** отправки необходимо использовать метод **ОтправитьСообщениеAVROСОжиданиемРезультата**, состав параметров и возвращаемое значение аналогичны методу асинхронной отправки **ОтправитьСообщениеAVRO**. 

```1c
УстановитьПараметр("queue.buffering.max.ms", "1");
УстановитьПараметр("socket.blocking.max.ms", "1");
УстановитьПараметр("message.timeout.ms", "5000");

Результат = ОтправитьСообщениеAVROСОжиданиемРезультата(Сообщение, Топик, Партиция, Ключ, Заголовки)
Если Результат <> 2 Тогда	// RD_KAFKA_MSG_STATUS_PERSISTED
  ВызватьИсключение Компонента.ПолучитьСообщениеОбОшибке();
КонецЕсли;
```

Список параметров метода идентичен методу *ОтправитьСообщениеAVRO*


### Сохранение данных в формате AVRO в файл

Файл **AVRO** можно сохранить в файл:

```1c
СохранитьФайлAVRO(ИмяФайла)
```

**ИмяФайла** - Строка. Обязательный.

**Возвращает** значение типа булево - "Истина", если операция выполнена успешно.
"Ложь", если была ошибка.
Текст ошибки можно получить функцией **ПолучитьСообщениеОбОшибке**.

---

### Декодирование AVRO сообщения

Метод **ДекодироватьСообщениеAVRO** позволяет декодировать AVRO сообщение обратно в JSON или получить двоичные данные.

```1c
ДекодироватьСообщениеAVRO(ДанныеAVRO, ИмяСхемыJSON, ВозвращатьJSON)
```

**ДанныеAVRO** - Строка или БинарныеДанные. Обязательный. AVRO данные для декодирования (например, полученные из Kafka через **ПолучитьДанныеСообщения**).

**ИмяСхемыJSON** - Строка. Необязательный. Имя схемы для декодирования. Если не указано или пустая строка, используется схема из самого AVRO файла.

**ВозвращатьJSON** - Булево. Необязательный. По умолчанию **Истина**:
- **Истина** - возвращает декодированные данные в формате JSON (такой же формат, как используется в **ПреобразоватьВФорматAVRO**)
- **Ложь** - возвращает исходные двоичные данные

**Возвращает**:
- При **ВозвращатьJSON = Истина**: Строка с JSON в формате `{"field1": [val1, val2, ...], "field2": [val1, val2, ...]}`
- При **ВозвращатьJSON = Ложь**: БинарныеДанные с исходным AVRO содержимым
- Пустая строка в случае ошибки. Текст ошибки можно получить функцией **ПолучитьСообщениеОбОшибке**.

#### Пример использования

Пример декодирования AVRO сообщения, полученного из Kafka:

```1С
// Инициализация и подписка на топик
Компонента.ИнициализироватьПотребителя("localhost:9092");
Компонента.Подписаться("USER");

// Получаем сообщение
Если Компонента.ПолучитьСообщение() Тогда

    // Получаем AVRO данные из сообщения
    ДанныеAVRO = Компонента.ПолучитьДанныеСообщения(Истина); // Истина = бинарные данные

    // Декодируем в JSON
    ДанныеJSON = Компонента.ДекодироватьСообщениеAVRO(
        ДанныеAVRO,
        "user",      // Имя схемы (опционально)
        Истина       // Возвращать JSON
    );

    Если ПустаяСтрока(ДанныеJSON) Тогда
        ВызватьИсключение Компонента.ПолучитьСообщениеОбОшибке();
    КонецЕсли;

    // Разбираем JSON
    // Формат: {"id": ["1", "2", "3"], "name": ["Ivan", "Maksim", "Vitaly"], ...}
    Сообщение(ДанныеJSON);

КонецЕсли;
```

Пример декодирования AVRO файла:

```1С
// Читаем AVRO файл
ДвоичныеДанные = Новый ДвоичныеДанные("C:\data\users.avro");

// Декодируем в JSON
ДанныеJSON = Компонента.ДекодироватьСообщениеAVRO(
    ДвоичныеДанные,
    "",          // Пустая строка = использовать схему из файла
    Истина       // Возвращать JSON
);

Если Не ПустаяСтрока(ДанныеJSON) Тогда
    Сообщение(ДанныеJSON);
Иначе
    ВызватьИсключение Компонента.ПолучитьСообщениеОбОшибке();
КонецЕсли;
```

**<span style="color: blue">Обратите внимание:</span>**
- Метод автоматически извлекает схему из AVRO файла, если **ИмяСхемыJSON** не указано
- Возвращаемый JSON имеет тот же формат, что и входной для **ПреобразоватьВФорматAVRO**
- Поддерживаются все типы данных: STRING, LONG, INT, FLOAT, DOUBLE, BOOL, NULL, UNION, FIXED, BYTES
- UUID автоматически преобразуется в строковый формат `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`

