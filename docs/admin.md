# Админ API

## Оглавление

| Метод | Описание |
|-------|----------|
| [УстановитьТаймаутАдминОпераций](#установитьтаймаутадминопераций) | Установка таймаута для Admin API операций |
| [СброситьМетрики](#сброситьметрики) | Сброс счетчиков метрик продюсера и консьюмера |
| [ПолучитьСписокТопиков](#получитьсписоктопиков) | Получение списка всех топиков брокера |
| [ПолучитьМетаданныеТопика](#получитьметаданныетопика) | Получение детальной информации о топике |
| [СоздатьТопик](#создатьтопик) | Создание нового топика |
| [УдалитьТопик](#удалитьтопик) | Удаление топика |
| [УдалитьЗаписи](#удалитьзаписи) | Удаление записей в топике до указанного offset |
| [ПолучитьНастройкиТопика](#получитьнастройкитопика) | Получение конфигурации топика |
| [УстановитьНастройкиТопика](#установитьнастройкитопика) | Изменение конфигурации топика |
| [ПолучитьОтставаниеКонсьюмера](#получитьотставаниеконсьюмера) | Получение lag консьюмера по топику |
| [ПолучитьКонсьюмеровТопика](#получитьконсьюмеровтопика) | Получение списка consumer groups топика |
| [УдалитьГруппуКонсьюмеров](#удалитьгруппуконсьюмеров) | Удаление группы консьюмеров |
| [СброситьОфсетыГруппыКонсьюмеров](#сброситьофсетыгруппыконсьюмеров) | Сброс офсетов группы консьюмеров |
| [ПолучитьИнформациюОКластере](#получитьинформациюокластере) | Получение информации о кластере Kafka |
| [ПолучитьИнформациюОБрокере](#получитьинформациюоброкере) | Получение информации о конкретном брокере |
| [ПолучитьГраницыПартиции](#получитьграницыпартиции) | Получение low/high watermarks партиции |
| [ПроверитьДоступностьБрокера](#проверитьдоступностьброкера) | Проверка доступности брокера (ping/health check) |
| [ПолучитьКоличествоСообщенийВПартиции](#получитьколичествосообщенийвпартиции) | Получение количества сообщений в партиции |
| [ПолучитьВозможностиБиблиотеки](#получитьвозможностибиблиотеки) | Получение информации о возможностях librdkafka |

---

## Методы компоненты и их описание

### УстановитьТаймаутАдминОпераций

Устанавливает таймаут ожидания для операций Admin API (создание/удаление топиков, изменение конфигурации и т.д.).

```1c
УстановитьТаймаутАдминОпераций(Таймаут)
```

**Таймаут** - Число. Таймаут в миллисекундах. По умолчанию 10000 (10 секунд).

Метод возвращает `Истина` при успешной установке, `Ложь` - при некорректном значении.

Пример использования:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

// Устанавливаем таймаут 30 секунд для админ-операций
Компонента.УстановитьТаймаутАдминОпераций(30000);

// Теперь создание топика будет ждать до 30 секунд
Если Компонента.СоздатьТопик("localhost:9092", "new-topic", 3, 1) Тогда
    Сообщить("Топик создан");
Иначе
    Сообщить("Ошибка: " + Компонента.ПолучитьСообщениеОбОшибке());
КонецЕсли;
```

> **Примечание:** Увеличьте таймаут, если операции на медленной сети или перегруженном кластере завершаются по таймауту.

---

### СброситьМетрики

Сбрасывает все счетчики метрик продюсера и консьюмера в нулевые значения.

```1c
СброситьМетрики()
```

Метод возвращает `Истина` при успешном сбросе.

Пример использования:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

Компонента.ИнициализироватьПродюсера("localhost:9092");

// Отправляем сообщения
Для Счетчик = 1 По 100 Цикл
    Компонента.ОтправитьСообщение("Сообщение " + Счетчик, "my-topic");
КонецЦикла;

// Получаем текущие метрики
Метрики1 = Компонента.ПолучитьМетрикиПродюсера();
Сообщить("До сброса: " + Метрики1);

// Сбрасываем метрики для нового интервала измерений
Компонента.СброситьМетрики();

// Отправляем еще сообщения
Для Счетчик = 1 По 50 Цикл
    Компонента.ОтправитьСообщение("Сообщение " + Счетчик, "my-topic");
КонецЦикла;

// Получаем метрики за новый интервал
Метрики2 = Компонента.ПолучитьМетрикиПродюсера();
Сообщить("После сброса: " + Метрики2);

Компонента.ОстановитьПродюсера();
```

**Практические применения:**

1. **Интервальные измерения** - сброс метрик для сбора статистики за определенный период.

2. **Тестирование** - начало измерений с чистого состояния.

3. **Мониторинг** - периодический сброс для получения дельты метрик.

---

### ПолучитьСписокТопиков

```1c
ПолучитьСписокТопиков(Брокер)
```

**Брокер** - Строка. Брокер, для которого необходимо получить список топиков.

Метод возвращает строку JSON.
Структура:
+ topics - Массив информации о топиках
  + topic - Топик брокера
  + partitions - Количество партиций в топике

---

### ПолучитьМетаданныеТопика

```1c
ПолучитьМетаданныеТопика(Брокер, ИмяТопика, Таймаут = 5000)
```

**Брокер** - Строка. Адрес брокера (например, "localhost:9092").

**ИмяТопика** - Строка. Имя топика, для которого необходимо получить метаданные.

**Таймаут** - Число. Таймаут ожидания ответа в миллисекундах. По умолчанию 5000.

Метод возвращает строку JSON с детальной информацией о топике.

Структура:
+ brokers - Массив информации о брокерах кластера
  + id - Идентификатор брокера
  + host - Хост брокера
  + port - Порт брокера
+ topic - Имя топика
+ partitions_count - Количество партиций в топике
+ partitions - Массив информации о партициях
  + id - Номер партиции
  + leader - ID брокера-лидера партиции
  + replicas - Массив ID брокеров, содержащих реплики
  + isrs - Массив ID брокеров в In-Sync Replicas (синхронизированные реплики)
  + error - Ошибка (если есть)
+ error - Ошибка топика (если есть)

Пример использования:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

// Опционально: установка параметров подключения
Компонента.УстановитьПараметр("security.protocol", "SASL_SSL");
Компонента.УстановитьПараметр("sasl.mechanisms", "PLAIN");
Компонента.УстановитьПараметр("sasl.username", "user");
Компонента.УстановитьПараметр("sasl.password", "password");

// Получение метаданных топика
РезультатJSON = Компонента.ПолучитьМетаданныеТопика("localhost:9092", "my-topic");

Если ПустаяСтрока(РезультатJSON) Тогда
    Сообщить("Ошибка: " + Компонента.ПолучитьСообщениеОбОшибке());
КонецЕсли;
```

Пример ответа:

```json
{
    "brokers": [
        {
            "id": "0",
            "host": "kafka-broker-1",
            "port": "9092"
        },
        {
            "id": "1",
            "host": "kafka-broker-2",
            "port": "9092"
        }
    ],
    "topic": "my-topic",
    "partitions_count": "3",
    "partitions": [
        {
            "id": "0",
            "leader": "0",
            "replicas": ["0", "1"],
            "isrs": ["0", "1"]
        },
        {
            "id": "1",
            "leader": "1",
            "replicas": ["1", "0"],
            "isrs": ["1", "0"]
        },
        {
            "id": "2",
            "leader": "0",
            "replicas": ["0", "1"],
            "isrs": ["0", "1"]
        }
    ]
}
```

---

### СоздатьТопик

```1c
СоздатьТопик(Брокер, ИмяТопика, КоличествоПартиций, ФакторРепликации)
```

**Брокер** - Строка. Адрес брокера (например, "localhost:9092").

**ИмяТопика** - Строка. Имя создаваемого топика.

**КоличествоПартиций** - Число. Количество партиций для топика.

**ФакторРепликации** - Число. Фактор репликации (количество реплик каждой партиции).

Метод возвращает `Истина` при успешном создании топика, `Ложь` - при ошибке.
В случае ошибки текст можно получить методом `ПолучитьСообщениеОбОшибке()`.

Пример использования:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

// Опционально: установка параметров подключения
Компонента.УстановитьПараметр("security.protocol", "SASL_SSL");
Компонента.УстановитьПараметр("sasl.mechanisms", "PLAIN");
Компонента.УстановитьПараметр("sasl.username", "user");
Компонента.УстановитьПараметр("sasl.password", "password");

// Создание топика с 3 партициями и фактором репликации 2
Если Компонента.СоздатьТопик("localhost:9092", "new-topic", 3, 2) Тогда
    Сообщить("Топик успешно создан");
Иначе
    Сообщить("Ошибка создания топика: " + Компонента.ПолучитьСообщениеОбОшибке());
КонецЕсли;
```

> **Примечание:** Для создания топиков требуются соответствующие права доступа на кластере Kafka.

---

### УдалитьТопик

```1c
УдалитьТопик(Брокер, ИмяТопика)
```

**Брокер** - Строка. Адрес брокера (например, "localhost:9092").

**ИмяТопика** - Строка. Имя удаляемого топика.

Метод возвращает `Истина` при успешном удалении топика, `Ложь` - при ошибке.
В случае ошибки текст можно получить методом `ПолучитьСообщениеОбОшибке()`.

Пример использования:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

// Опционально: установка параметров подключения
Компонента.УстановитьПараметр("security.protocol", "SASL_SSL");
Компонента.УстановитьПараметр("sasl.mechanisms", "PLAIN");
Компонента.УстановитьПараметр("sasl.username", "user");
Компонента.УстановитьПараметр("sasl.password", "password");

// Удаление топика
Если Компонента.УдалитьТопик("localhost:9092", "old-topic") Тогда
    Сообщить("Топик успешно удален");
Иначе
    Сообщить("Ошибка удаления топика: " + Компонента.ПолучитьСообщениеОбОшибке());
КонецЕсли;
```

> **Внимание:** Удаление топика является необратимой операцией. Все данные в топике будут безвозвратно удалены.
> Для удаления топиков требуются соответствующие права доступа на кластере Kafka, а также параметр `delete.topic.enable=true` в конфигурации брокера.

---

### УдалитьЗаписи

```1c
УдалитьЗаписи(Брокер, ИмяТопика, ПартицииJSON, Таймаут = 10000)
```

**Брокер** - Строка. Адрес брокера (например, "localhost:9092").

**ИмяТопика** - Строка. Имя топика, в котором необходимо удалить записи.

**ПартицииJSON** - Строка. JSON-объект с партициями и offset'ами, до которых нужно удалить записи. Формат: `{"partitions": [{"partition": 0, "offset": 100}, {"partition": 1, "offset": 200}]}`.

**Таймаут** - Число. Таймаут ожидания ответа в миллисекундах. По умолчанию 10000.

Метод возвращает `Истина` при успешном удалении записей, `Ложь` - при ошибке.
В случае ошибки текст можно получить методом `ПолучитьСообщениеОбОшибке()`.

Метод удаляет записи в указанных партициях топика до заданного offset (не включая сам offset). Например, если указан offset 100, будут удалены записи с offset 0 до 99 включительно.

Пример использования:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

// Опционально: установка параметров подключения
Компонента.УстановитьПараметр("security.protocol", "SASL_SSL");
Компонента.УстановитьПараметр("sasl.mechanisms", "PLAIN");
Компонента.УстановитьПараметр("sasl.username", "user");
Компонента.УстановитьПараметр("sasl.password", "password");

// Удаление записей в партициях 0 и 1 до указанных offset'ов
// В партиции 0 удалятся записи с offset 0 до 999
// В партиции 1 удалятся записи с offset 0 до 1999
ПартицииJSON = "{""partitions"": [{""partition"": 0, ""offset"": 1000}, {""partition"": 1, ""offset"": 2000}]}";

Если Компонента.УдалитьЗаписи("localhost:9092", "my-topic", ПартицииJSON) Тогда
    Сообщить("Записи успешно удалены");
Иначе
    Сообщить("Ошибка удаления записей: " + Компонента.ПолучитьСообщениеОбОшибке());
КонецЕсли;
```

Пример JSON для параметра ПартицииJSON:

```json
{
    "partitions": [
        {
            "partition": 0,
            "offset": 1000
        },
        {
            "partition": 1,
            "offset": 2000
        }
    ]
}
```

> **Внимание:** Удаление записей является необратимой операцией. Удаленные сообщения не могут быть восстановлены.
> Операция удаляет только физические данные, но не влияет на committed offsets групп консьюмеров.
> Для удаления записей требуются соответствующие права доступа на кластере Kafka.
> Минимальная версия Kafka для поддержки deleteRecords: 0.11.0+.

---

### ПолучитьНастройкиТопика

```1c
ПолучитьНастройкиТопика(Брокер, ИмяТопика, Таймаут = 5000)
```

**Брокер** - Строка. Адрес брокера (например, "localhost:9092").

**ИмяТопика** - Строка. Имя топика, для которого необходимо получить настройки.

**Таймаут** - Число. Таймаут ожидания ответа в миллисекундах. По умолчанию 5000.

Метод возвращает строку JSON с конфигурацией топика.

Структура:
+ topic - Имя топика
+ configs - Массив параметров конфигурации
  + name - Имя параметра
  + value - Значение параметра
  + is_read_only - Параметр только для чтения (true/false)
  + is_default - Используется значение по умолчанию (true/false)
  + is_sensitive - Чувствительные данные, значение скрыто (true/false)
  + source - Источник значения (DYNAMIC_TOPIC_CONFIG, DEFAULT_CONFIG и др.)

Пример использования:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

// Опционально: установка параметров подключения
Компонента.УстановитьПараметр("security.protocol", "SASL_SSL");
Компонента.УстановитьПараметр("sasl.mechanisms", "PLAIN");
Компонента.УстановитьПараметр("sasl.username", "user");
Компонента.УстановитьПараметр("sasl.password", "password");

// Получение настроек топика
РезультатJSON = Компонента.ПолучитьНастройкиТопика("localhost:9092", "my-topic");

Если ПустаяСтрока(РезультатJSON) Тогда
    Сообщить("Ошибка: " + Компонента.ПолучитьСообщениеОбОшибке());
КонецЕсли;
```

Пример ответа:

```json
{
    "topic": "my-topic",
    "configs": [
        {
            "name": "retention.ms",
            "value": "604800000",
            "is_read_only": "false",
            "is_default": "true",
            "is_sensitive": "false",
            "source": "DEFAULT_CONFIG"
        },
        {
            "name": "cleanup.policy",
            "value": "delete",
            "is_read_only": "false",
            "is_default": "true",
            "is_sensitive": "false",
            "source": "DEFAULT_CONFIG"
        },
        {
            "name": "max.message.bytes",
            "value": "1048588",
            "is_read_only": "false",
            "is_default": "true",
            "is_sensitive": "false",
            "source": "DEFAULT_CONFIG"
        }
    ]
}
```

---

### УстановитьНастройкиТопика

```1c
УстановитьНастройкиТопика(Брокер, ИмяТопика, НастройкиJSON, Таймаут = 10000)
```

**Брокер** - Строка. Адрес брокера (например, "localhost:9092").

**ИмяТопика** - Строка. Имя топика, для которого необходимо изменить настройки.

**НастройкиJSON** - Строка. JSON-объект с параметрами конфигурации в формате `{"параметр": "значение"}`.

**Таймаут** - Число. Таймаут ожидания ответа в миллисекундах. По умолчанию 10000.

Метод возвращает `Истина` при успешном изменении настроек, `Ложь` - при ошибке.
В случае ошибки текст можно получить методом `ПолучитьСообщениеОбОшибке()`.

Пример использования:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

// Опционально: установка параметров подключения
Компонента.УстановитьПараметр("security.protocol", "SASL_SSL");
Компонента.УстановитьПараметр("sasl.mechanisms", "PLAIN");
Компонента.УстановитьПараметр("sasl.username", "user");
Компонента.УстановитьПараметр("sasl.password", "password");

// Изменение настроек топика
// retention.ms = 86400000 (1 день в миллисекундах)
// max.message.bytes = 2097152 (2 МБ)
НастройкиJSON = "{""retention.ms"": ""86400000"", ""max.message.bytes"": ""2097152""}";

Если Компонента.УстановитьНастройкиТопика("localhost:9092", "my-topic", НастройкиJSON) Тогда
    Сообщить("Настройки топика успешно изменены");
Иначе
    Сообщить("Ошибка изменения настроек: " + Компонента.ПолучитьСообщениеОбОшибке());
КонецЕсли;
```

Часто используемые параметры конфигурации топика:

| Параметр | Описание | Пример значения |
|----------|----------|-----------------|
| retention.ms | Время хранения сообщений (мс) | 604800000 (7 дней) |
| retention.bytes | Максимальный размер лога партиции | 1073741824 (1 ГБ) |
| max.message.bytes | Максимальный размер сообщения | 1048576 (1 МБ) |
| cleanup.policy | Политика очистки (delete/compact) | delete |
| min.insync.replicas | Минимум синхронных реплик | 2 |
| segment.bytes | Размер сегмента лога | 1073741824 (1 ГБ) |

> **Примечание:** Для изменения настроек топиков требуются соответствующие права доступа на кластере Kafka.

---

### ПолучитьОтставаниеКонсьюмера

```1c
ПолучитьОтставаниеКонсьюмера(Брокер, ИмяТопика, ГруппаКонсьюмеров, Таймаут = 5000)
```

**Брокер** - Строка. Адрес брокера (например, "localhost:9092").

**ИмяТопика** - Строка. Имя топика.

**ГруппаКонсьюмеров** - Строка. Идентификатор группы консьюмеров.

**Таймаут** - Число. Таймаут ожидания ответа в миллисекундах. По умолчанию 5000.

Метод возвращает строку JSON с информацией об отставании (lag) консьюмера.

Структура:
+ topic - Имя топика
+ consumer_group - Группа консьюмеров
+ total_lag - Суммарное отставание по всем партициям
+ partitions - Массив информации о партициях
  + partition - Номер партиции
  + low_watermark - Минимальный offset в партиции
  + high_watermark - Максимальный offset (конец лога)
  + committed_offset - Зафиксированный offset группы (или "none" если не зафиксирован)
  + lag - Отставание (high_watermark - committed_offset)

Пример использования:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

// Опционально: установка параметров подключения
Компонента.УстановитьПараметр("security.protocol", "SASL_SSL");
Компонента.УстановитьПараметр("sasl.mechanisms", "PLAIN");
Компонента.УстановитьПараметр("sasl.username", "user");
Компонента.УстановитьПараметр("sasl.password", "password");

// Получение отставания консьюмера
РезультатJSON = Компонента.ПолучитьОтставаниеКонсьюмера("localhost:9092", "my-topic", "my-consumer-group");

Если ПустаяСтрока(РезультатJSON) Тогда
    Сообщить("Ошибка: " + Компонента.ПолучитьСообщениеОбОшибке());
Иначе
    // Парсинг JSON и анализ отставания
    ЧтениеJSON = Новый ЧтениеJSON;
    ЧтениеJSON.УстановитьСтроку(РезультатJSON);
    Результат = ПрочитатьJSON(ЧтениеJSON);

    Сообщить("Общее отставание: " + Результат["total_lag"]);
КонецЕсли;
```

Пример ответа:

```json
{
    "topic": "my-topic",
    "consumer_group": "my-consumer-group",
    "total_lag": "150",
    "partitions": [
        {
            "partition": "0",
            "low_watermark": "0",
            "high_watermark": "1000",
            "committed_offset": "950",
            "lag": "50"
        },
        {
            "partition": "1",
            "low_watermark": "0",
            "high_watermark": "2000",
            "committed_offset": "1900",
            "lag": "100"
        }
    ]
}
```

> **Примечание:** Метод полезен для мониторинга состояния обработки сообщений. Большое значение lag может указывать на то, что консьюмер не успевает обрабатывать входящий поток сообщений.

---

### ПолучитьКонсьюмеровТопика

```1c
ПолучитьКонсьюмеровТопика(Брокер, ИмяТопика, Таймаут = 5000)
```

**Брокер** - Строка. Адрес брокера (например, "localhost:9092").

**ИмяТопика** - Строка. Имя топика, для которого необходимо получить список консьюмеров.

**Таймаут** - Число. Таймаут ожидания ответа в миллисекундах. По умолчанию 5000.

Метод возвращает строку JSON со списком групп консьюмеров, имеющих committed offsets для указанного топика. Метод находит группы в любом состоянии (Stable, Empty, Dead и др.).

Структура:
+ topic - Имя топика
+ groups_count - Количество найденных групп консьюмеров
+ consumer_groups - Массив информации о группах
  + group_id - Идентификатор группы консьюмеров
  + state - Состояние группы (Stable, Empty, Dead, PreparingRebalance, CompletingRebalance)
  + offsets - Массив committed offsets группы для данного топика
    + partition - Номер партиции
    + offset - Зафиксированное смещение

Пример использования:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

// Опционально: установка параметров подключения
Компонента.УстановитьПараметр("security.protocol", "SASL_SSL");
Компонента.УстановитьПараметр("sasl.mechanisms", "PLAIN");
Компонента.УстановитьПараметр("sasl.username", "user");
Компонента.УстановитьПараметр("sasl.password", "password");

// Получение списка консьюмеров топика
РезультатJSON = Компонента.ПолучитьКонсьюмеровТопика("localhost:9092", "my-topic");

Если ПустаяСтрока(РезультатJSON) Тогда
    Сообщить("Ошибка: " + Компонента.ПолучитьСообщениеОбОшибке());
Иначе
    // Парсинг JSON
    ЧтениеJSON = Новый ЧтениеJSON;
    ЧтениеJSON.УстановитьСтроку(РезультатJSON);
    Результат = ПрочитатьJSON(ЧтениеJSON);

    Сообщить("Найдено групп консьюмеров: " + Результат["groups_count"]);

    Для Каждого Группа Из Результат["consumer_groups"] Цикл
        Сообщить("Группа: " + Группа["group_id"] + ", состояние: " + Группа["state"]);
        Для Каждого Смещение Из Группа["offsets"] Цикл
            Сообщить("  Партиция " + Смещение["partition"] + ": offset=" + Смещение["offset"]);
        КонецЦикла;
    КонецЦикла;
КонецЕсли;
```

Пример ответа:

```json
{
    "topic": "my-topic",
    "groups_count": "2",
    "consumer_groups": [
        {
            "group_id": "my-consumer-group-1",
            "state": "Stable",
            "offsets": [
                {
                    "partition": "0",
                    "offset": "1500"
                },
                {
                    "partition": "1",
                    "offset": "2300"
                }
            ]
        },
        {
            "group_id": "my-consumer-group-2",
            "state": "Empty",
            "offsets": [
                {
                    "partition": "0",
                    "offset": "800"
                }
            ]
        }
    ]
}
```

> **Примечание:** Метод возвращает все группы консьюмеров, имеющие committed offsets для указанного топика, независимо от их текущего состояния. Это позволяет находить группы в состоянии Empty (без активных членов), которые ранее читали топик.

---

### УдалитьГруппуКонсьюмеров

```1c
УдалитьГруппуКонсьюмеров(Брокер, ИдентификаторГруппы)
```

Удаляет офсеты указанной группы консьюмеров.

**Брокер** - Строка. Адрес брокера (например, "localhost:9092").

**ИдентификаторГруппы** - Строка. Идентификатор группы консьюмеров для удаления.

Метод возвращает `Истина` при успешном удалении, `Ложь` - при ошибке.
В случае ошибки текст можно получить методом `ПолучитьСообщениеОбОшибке()`.

Пример использования:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

Если Компонента.УдалитьГруппуКонсьюмеров("localhost:9092", "old-consumer-group") Тогда
    Сообщить("Группа консьюмеров успешно удалена");
Иначе
    Сообщить("Ошибка: " + Компонента.ПолучитьСообщениеОбОшибке());
КонецЕсли;
```

> **Важно:**
> - Группа должна быть неактивной (без активных консьюмеров)
> - Удаляются только офсеты группы, сама группа пересоздается при подключении консьюмера
> - Требуются соответствующие права доступа на кластере Kafka

---

### СброситьОфсетыГруппыКонсьюмеров

```1c
СброситьОфсетыГруппыКонсьюмеров(Брокер, ИдентификаторГруппы, ИмяТопика, ПозицияСброса)
```

Сбрасывает офсеты группы консьюмеров для указанного топика.

**Брокер** - Строка. Адрес брокера (например, "localhost:9092").

**ИдентификаторГруппы** - Строка. Идентификатор группы консьюмеров.

**ИмяТопика** - Строка. Имя топика, для которого сбрасываются офсеты.

**ПозицияСброса** - Строка. Позиция для сброса офсетов:
- `"earliest"` - начало партиции
- `"latest"` - конец партиции
- Числовое значение (timestamp в миллисекундах)

Метод возвращает `Истина` при успешном сбросе, `Ложь` - при ошибке.
В случае ошибки текст можно получить методом `ПолучитьСообщениеОбОшибке()`.

> **Важно:** Для использования этого метода необходим инициализированный консьюмер (`ИнициализироватьКонсьюмера`).

Пример использования:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

// Инициализируем консьюмера
Компонента.УстановитьПараметр("group.id", "my-consumer-group");
Компонента.ИнициализироватьКонсьюмера("localhost:9092");

// Сбрасываем офсеты на начало топика
Если Компонента.СброситьОфсетыГруппыКонсьюмеров("localhost:9092", "my-consumer-group", "my-topic", "earliest") Тогда
    Сообщить("Офсеты успешно сброшены на начало");
Иначе
    Сообщить("Ошибка: " + Компонента.ПолучитьСообщениеОбОшибке());
КонецЕсли;

// Или сбрасываем на определенную временную метку (1 января 2024, 00:00:00 UTC)
ВременнаяМетка = "1704067200000"; // миллисекунды
Если Компонента.СброситьОфсетыГруппыКонсьюмеров("localhost:9092", "my-consumer-group", "my-topic", ВременнаяМетка) Тогда
    Сообщить("Офсеты успешно сброшены на указанную дату");
КонецЕсли;
```

---

### ПолучитьИнформациюОКластере

```1c
ПолучитьИнформациюОКластере(Брокер)
```

Получает общую информацию о кластере Kafka, включая список брокеров и контроллера.

**Брокер** - Строка. Адрес брокера (например, "localhost:9092").

Метод возвращает строку JSON с информацией о кластере.

Структура:
+ cluster_id - ID брокера, к которому выполнено подключение
+ brokers_count - Количество брокеров в кластере
+ topics_count - Количество топиков в кластере
+ brokers - Массив информации о брокерах
  + id - ID брокера
  + host - Хост брокера
  + port - Порт брокера

Пример использования:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

// Опционально: установка параметров подключения
Компонента.УстановитьПараметр("security.protocol", "SASL_SSL");
Компонента.УстановитьПараметр("sasl.mechanisms", "PLAIN");
Компонента.УстановитьПараметр("sasl.username", "user");
Компонента.УстановитьПараметр("sasl.password", "password");

// Получение информации о кластере
РезультатJSON = Компонента.ПолучитьИнформациюОКластере("localhost:9092");

Если ПустаяСтрока(РезультатJSON) Тогда
    Сообщить("Ошибка: " + Компонента.ПолучитьСообщениеОбОшибке());
Иначе
    // Парсинг JSON
    ЧтениеJSON = Новый ЧтениеJSON;
    ЧтениеJSON.УстановитьСтроку(РезультатJSON);
    Результат = ПрочитатьJSON(ЧтениеJSON);

    Сообщить("Кластер содержит " + Результат["brokers_count"] + " брокеров");
    Сообщить("Всего топиков: " + Результат["topics_count"]);
КонецЕсли;
```

Пример ответа:

```json
{
    "cluster_id": "0",
    "brokers_count": "3",
    "topics_count": "15",
    "brokers": [
        {
            "id": "0",
            "host": "kafka-broker-1",
            "port": "9092"
        },
        {
            "id": "1",
            "host": "kafka-broker-2",
            "port": "9092"
        },
        {
            "id": "2",
            "host": "kafka-broker-3",
            "port": "9092"
        }
    ]
}
```

---

### ПолучитьИнформациюОБрокере

```1c
ПолучитьИнформациюОБрокере(Брокер, IDBрокера)
```

Получает детальную информацию о конкретном брокере.

**Брокер** - Строка. Адрес брокера (например, "localhost:9092").

**IDBрокера** - Число. ID брокера, информацию о котором необходимо получить.

Метод возвращает строку JSON с детальной информацией о брокере.

Структура:
+ id - ID брокера
+ host - Хост брокера
+ port - Порт брокера
+ leader_partitions_count - Количество партиций, где этот брокер является лидером
+ replica_partitions_count - Количество партиций, реплики которых хранятся на этом брокере

Пример использования:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

// Получение информации о брокере с ID = 1
РезультатJSON = Компонента.ПолучитьИнформациюОБрокере("localhost:9092", 1);

Если ПустаяСтрока(РезультатJSON) Тогда
    Сообщить("Ошибка: " + Компонента.ПолучитьСообщениеОбОшибке());
Иначе
    // Парсинг JSON
    ЧтениеJSON = Новый ЧтениеJSON;
    ЧтениеJSON.УстановитьСтроку(РезультатJSON);
    Брокер = ПрочитатьJSON(ЧтениеJSON);

    Сообщить("Брокер: " + Брокер["host"] + ":" + Брокер["port"]);
    Сообщить("Лидер партиций: " + Брокер["leader_partitions_count"]);
    Сообщить("Реплик партиций: " + Брокер["replica_partitions_count"]);
КонецЕсли;
```

Пример ответа:

```json
{
    "id": "1",
    "host": "kafka-broker-2",
    "port": "9092",
    "leader_partitions_count": 25,
    "replica_partitions_count": 50
}
```

---

### ПолучитьГраницыПартиции

```1c
ПолучитьГраницыПартиции(Брокер, ИмяТопика, Партиция)
```

Получает информацию о границах (watermarks) партиции топика.

**Брокер** - Строка. Адрес брокера (например, "localhost:9092").

**ИмяТопика** - Строка. Имя топика.

**Партиция** - Число. Номер партиции.

Метод возвращает строку JSON с информацией о границах партиции.

Структура:
+ topic - Имя топика
+ partition - Номер партиции
+ low_watermark - Минимальный доступный offset (oldest offset)
+ high_watermark - Максимальный offset (offset следующего сообщения)
+ message_count - Количество сообщений в партиции (high - low)

> **Справка о Watermarks:**
> - **Low Watermark** - самый ранний доступный offset в партиции. Сообщения с меньшими offset'ами уже удалены согласно политике retention.
> - **High Watermark** - offset следующего сообщения, которое будет записано. Это не offset последнего сообщения, а offset + 1.
> - **Message Count** - количество сообщений, доступных для чтения (high_watermark - low_watermark).

Пример использования:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

// Получение watermarks для партиции 0 топика "my-topic"
РезультатJSON = Компонента.ПолучитьГраницыПартиции("localhost:9092", "my-topic", 0);

Если ПустаяСтрока(РезультатJSON) Тогда
    Сообщить("Ошибка: " + Компонента.ПолучитьСообщениеОбОшибке());
Иначе
    // Парсинг JSON
    ЧтениеJSON = Новый ЧтениеJSON;
    ЧтениеJSON.УстановитьСтроку(РезультатJSON);
    Watermarks = ПрочитатьJSON(ЧтениеJSON);

    Сообщить("Топик: " + Watermarks["topic"] + ", партиция: " + Watermarks["partition"]);
    Сообщить("Low watermark (первый offset): " + Watermarks["low_watermark"]);
    Сообщить("High watermark (следующий offset): " + Watermarks["high_watermark"]);
    Сообщить("Количество сообщений: " + Watermarks["message_count"]);
КонецЕсли;
```

Пример ответа:

```json
{
    "topic": "my-topic",
    "partition": "0",
    "low_watermark": "0",
    "high_watermark": "15423",
    "message_count": "15423"
}
```

**Практические применения:**

1. **Мониторинг объема данных** - используйте message_count для отслеживания количества сообщений в партициях.

2. **Проверка retention** - если low_watermark > 0, значит старые сообщения были удалены согласно политике retention.

3. **Планирование чтения** - используйте watermarks для определения диапазона offset'ов при создании консьюмера.

4. **Определение отставания** - сравните текущий offset консьюмера с high_watermark для вычисления lag.

Пример вычисления отставания консьюмера:

```1c
// Получаем текущий committed offset консьюмера
ТекущийOffset = 14500; // получен от консьюмера

// Получаем high watermark партиции
РезультатJSON = Компонента.ПолучитьГраницыПартиции("localhost:9092", "my-topic", 0);
ЧтениеJSON = Новый ЧтениеJSON;
ЧтениеJSON.УстановитьСтроку(РезультатJSON);
Watermarks = ПрочитатьJSON(ЧтениеJSON);

HighWatermark = Число(Watermarks["high_watermark"]);
Отставание = HighWatermark - ТекущийOffset;

Сообщить("Отставание консьюмера: " + Отставание + " сообщений");
```

---

### ПроверитьДоступностьБрокера

```1c
ПроверитьДоступностьБрокера(Брокер, Таймаут)
```

Проверяет доступность брокера Kafka (ping/health check).

**Брокер** - Строка. Адрес брокера (например, "localhost:9092").

**Таймаут** - Число. Таймаут ожидания ответа в миллисекундах.

Метод возвращает `Истина` если брокер доступен, `Ложь` - если недоступен.
В случае недоступности текст ошибки можно получить методом `ПолучитьСообщениеОбОшибке()`.

> **Примечание:** Метод выполняет быструю проверку подключения к брокеру через запрос метаданных.

Пример использования:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

// Опционально: установка параметров подключения
Компонента.УстановитьПараметр("security.protocol", "SASL_SSL");
Компонента.УстановитьПараметр("sasl.mechanisms", "PLAIN");
Компонента.УстановитьПараметр("sasl.username", "user");
Компонента.УстановитьПараметр("sasl.password", "password");

// Проверка доступности брокера с таймаутом 3 секунды
Если Компонента.ПроверитьДоступностьБрокера("localhost:9092", 3000) Тогда
    Сообщить("Брокер доступен");
Иначе
    Сообщить("Брокер недоступен: " + Компонента.ПолучитьСообщениеОбОшибке());
КонецЕсли;
```

**Практические применения:**

1. **Health Check** - проверка доступности Kafka перед началом работы приложения.

2. **Мониторинг** - периодическая проверка состояния брокеров в кластере.

3. **Failover** - автоматическое переключение на резервный брокер при недоступности основного.

4. **Валидация конфигурации** - проверка корректности настроек подключения.

Пример мониторинга нескольких брокеров:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

МассивБрокеров = Новый Массив;
МассивБрокеров.Добавить("broker1:9092");
МассивБрокеров.Добавить("broker2:9092");
МассивБрокеров.Добавить("broker3:9092");

Для Каждого Брокер Из МассивБрокеров Цикл
    Если Компонента.ПроверитьДоступностьБрокера(Брокер, 2000) Тогда
        Сообщить(Брокер + " - доступен");
    Иначе
        Сообщить(Брокер + " - недоступен: " + Компонента.ПолучитьСообщениеОбОшибке());
    КонецЕсли;
КонецЦикла;
```

---

### ПолучитьКоличествоСообщенийВПартиции

```1c
ПолучитьКоличествоСообщенийВПартиции(Брокер, ИмяТопика, Партиция)
```

Возвращает количество сообщений в указанной партиции топика.

**Брокер** - Строка. Адрес брокера (например, "localhost:9092").

**ИмяТопика** - Строка. Имя топика.

**Партиция** - Число. Номер партиции.

Метод возвращает количество сообщений (число) в партиции. При ошибке возвращает -1.
Текст ошибки можно получить методом `ПолучитьСообщениеОбОшибке()`.

> **Примечание:** Метод вычисляет количество сообщений как разницу между high watermark и low watermark.

Пример использования:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

// Получение количества сообщений в партиции 0 топика "my-topic"
Количество = Компонента.ПолучитьКоличествоСообщенийВПартиции("localhost:9092", "my-topic", 0);

Если Количество >= 0 Тогда
    Сообщить("В партиции 0 топика my-topic содержится " + Количество + " сообщений");
Иначе
    Сообщить("Ошибка: " + Компонента.ПолучитьСообщениеОбОшибке());
КонецЕсли;
```

**Практические применения:**

1. **Мониторинг объема данных** - отслеживание количества сообщений в партициях.

2. **Планирование ресурсов** - оценка объема данных для обработки.

3. **Балансировка нагрузки** - определение партиций с наибольшим объемом данных.

4. **Проверка записи** - подтверждение что сообщения были записаны в топик.

Пример подсчета общего количества сообщений во всех партициях топика:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

// Получаем метаданные топика для определения количества партиций
РезультатJSON = Компонента.ПолучитьМетаданныеТопика("localhost:9092", "my-topic");

Если ПустаяСтрока(РезультатJSON) Тогда
    Сообщить("Ошибка: " + Компонента.ПолучитьСообщениеОбОшибке());
Иначе
    // Парсинг JSON
    ЧтениеJSON = Новый ЧтениеJSON;
    ЧтениеJSON.УстановитьСтроку(РезультатJSON);
    Метаданные = ПрочитатьJSON(ЧтениеJSON);

    КоличествоПартиций = Число(Метаданные["partitions_count"]);
    ОбщееКоличество = 0;

    // Подсчитываем сообщения в каждой партиции
    Для Партиция = 0 По КоличествоПартиций - 1 Цикл
        КоличествоВПартиции = Компонента.ПолучитьКоличествоСообщенийВПартиции("localhost:9092", "my-topic", Партиция);

        Если КоличествоВПартиции >= 0 Тогда
            ОбщееКоличество = ОбщееКоличество + КоличествоВПартиции;
            Сообщить("Партиция " + Партиция + ": " + КоличествоВПартиции + " сообщений");
        Иначе
            Сообщить("Ошибка при чтении партиции " + Партиция);
        КонецЕсли;
    КонецЦикла;

    Сообщить("Всего в топике my-topic: " + ОбщееКоличество + " сообщений");
КонецЕсли;
```

---

### ПолучитьВозможностиБиблиотеки

```1c
ПолучитьВозможностиБиблиотеки()
```

Возвращает информацию о версии и доступных возможностях библиотеки librdkafka.

Метод возвращает строку JSON с информацией о библиотеке.

Структура:
+ version - Версия библиотеки librdkafka
+ builtin_features - Строка с перечислением всех доступных функций через запятую
+ features - Массив доступных функций

Возможные функции:
| Функция | Описание |
|---------|----------|
| gzip | Поддержка сжатия Gzip |
| snappy | Поддержка сжатия Snappy |
| lz4 | Поддержка сжатия LZ4 |
| zstd | Поддержка сжатия Zstandard |
| ssl | Поддержка SSL/TLS шифрования |
| sasl | Поддержка SASL аутентификации |
| sasl_plain | Механизм SASL PLAIN |
| sasl_scram | Механизм SASL SCRAM |
| sasl_gssapi | Механизм SASL GSSAPI (Kerberos) |
| sasl_oauthbearer | Механизм SASL OAUTHBEARER |
| regex | Поддержка регулярных выражений |
| http | Поддержка HTTP |
| oidc | Поддержка OpenID Connect |

> **Примечание:** Метод не требует подключения к брокеру Kafka. Информация получается из самой библиотеки librdkafka.

Пример использования:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

// Получение информации о возможностях библиотеки
РезультатJSON = Компонента.ПолучитьВозможностиБиблиотеки();

// Парсинг JSON
ЧтениеJSON = Новый ЧтениеJSON;
ЧтениеJSON.УстановитьСтроку(РезультатJSON);
Результат = ПрочитатьJSON(ЧтениеJSON);

Сообщить("Версия librdkafka: " + Результат["version"]);
Сообщить("Доступные функции: " + Результат["builtin_features"]);

// Проверка поддержки конкретной функции
Если СтрНайти(Результат["builtin_features"], "ssl") > 0 Тогда
    Сообщить("SSL поддерживается");
Иначе
    Сообщить("SSL не поддерживается в этой сборке");
КонецЕсли;
```

Пример ответа:

```json
{
    "version": "2.3.0",
    "builtin_features": "gzip,snappy,ssl,sasl,regex,lz4,sasl_plain,sasl_scram,plugins,zstd,sasl_oauthbearer",
    "features": [
        "gzip",
        "snappy",
        "ssl",
        "sasl",
        "regex",
        "lz4",
        "sasl_plain",
        "sasl_scram",
        "plugins",
        "zstd",
        "sasl_oauthbearer"
    ]
}
```

**Практические применения:**

1. **Диагностика проблем с SSL** - если SSL не работает, проверьте наличие функции `ssl` в списке.

2. **Проверка поддержки сжатия** - перед использованием сжатия (например, `compression.type=snappy`) убедитесь, что библиотека скомпилирована с его поддержкой.

3. **Диагностика проблем с аутентификацией** - проверьте наличие нужного механизма SASL (`sasl_plain`, `sasl_scram`, `sasl_gssapi`).

4. **Документирование окружения** - сохраните информацию о версии и возможностях для отладки и поддержки.

Пример проверки перед настройкой SSL:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

РезультатJSON = Компонента.ПолучитьВозможностиБиблиотеки();
ЧтениеJSON = Новый ЧтениеJSON;
ЧтениеJSON.УстановитьСтроку(РезультатJSON);
Возможности = ПрочитатьJSON(ЧтениеJSON);

Если СтрНайти(Возможности["builtin_features"], "ssl") = 0 Тогда
    ВызватьИсключение "Библиотека librdkafka скомпилирована без поддержки SSL.
        |Подключение к защищенному кластеру невозможно.";
КонецЕсли;

// SSL поддерживается, можно настраивать подключение
Компонента.УстановитьПараметр("security.protocol", "SSL");
Компонента.УстановитьПараметр("ssl.ca.location", "/path/to/ca-cert.pem");
```
