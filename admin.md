# Админ API

## Оглавление

| Метод | Описание |
|-------|----------|
| [ПолучитьСписокТопиков](#получитьсписоктопиков) | Получение списка всех топиков брокера |
| [ПолучитьМетаданныеТопика](#получитьметаданныетопика) | Получение детальной информации о топике |
| [СоздатьТопик](#создатьтопик) | Создание нового топика |
| [УдалитьТопик](#удалитьтопик) | Удаление топика |
| [ПолучитьНастройкиТопика](#получитьнастройкитопика) | Получение конфигурации топика |
| [УстановитьНастройкиТопика](#установитьнастройкитопика) | Изменение конфигурации топика |
| [ПолучитьОтставаниеКонсьюмера](#получитьотставаниеконсьюмера) | Получение lag консьюмера по топику |
| [ПолучитьКонсьюмеровТопика](#получитьконсьюмеровтопика) | Получение списка consumer groups топика |

---

## Методы компоненты и их описание

### ПолучитьСписокТопиков

```1c
ПолучитьСписокТопиков(Брокер)
```

**Брокер** - Строка. Брокер, для которого необходимо получить список топиков.

Метод возвращает строку JSON.
Структура:
+ topics - Массив информации о топиках
+ topic - Топик брокера
+ partitions - Количество партиций в топике

---

### ПолучитьМетаданныеТопика

```1c
ПолучитьМетаданныеТопика(Брокер, ИмяТопика, Таймаут = 5000)
```

**Брокер** - Строка. Адрес брокера (например, "localhost:9092").

**ИмяТопика** - Строка. Имя топика, для которого необходимо получить метаданные.

**Таймаут** - Число. Таймаут ожидания ответа в миллисекундах. По умолчанию 5000.

Метод возвращает строку JSON с детальной информацией о топике.

Структура:
+ brokers - Массив информации о брокерах кластера
  + id - Идентификатор брокера
  + host - Хост брокера
  + port - Порт брокера
+ topic - Имя топика
+ partitions_count - Количество партиций в топике
+ partitions - Массив информации о партициях
  + id - Номер партиции
  + leader - ID брокера-лидера партиции
  + replicas - Массив ID брокеров, содержащих реплики
  + isrs - Массив ID брокеров в In-Sync Replicas (синхронизированные реплики)
  + error - Ошибка (если есть)
+ error - Ошибка топика (если есть)

Пример использования:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

// Опционально: установка параметров подключения
Компонента.УстановитьПараметр("security.protocol", "SASL_SSL");
Компонента.УстановитьПараметр("sasl.mechanisms", "PLAIN");
Компонента.УстановитьПараметр("sasl.username", "user");
Компонента.УстановитьПараметр("sasl.password", "password");

// Получение метаданных топика
РезультатJSON = Компонента.ПолучитьМетаданныеТопика("localhost:9092", "my-topic");

Если ПустаяСтрока(РезультатJSON) Тогда
    Сообщить("Ошибка: " + Компонента.ПолучитьСообщениеОбОшибке());
КонецЕсли;
```

Пример ответа:

```json
{
    "brokers": [
        {
            "id": "0",
            "host": "kafka-broker-1",
            "port": "9092"
        },
        {
            "id": "1",
            "host": "kafka-broker-2",
            "port": "9092"
        }
    ],
    "topic": "my-topic",
    "partitions_count": "3",
    "partitions": [
        {
            "id": "0",
            "leader": "0",
            "replicas": ["0", "1"],
            "isrs": ["0", "1"]
        },
        {
            "id": "1",
            "leader": "1",
            "replicas": ["1", "0"],
            "isrs": ["1", "0"]
        },
        {
            "id": "2",
            "leader": "0",
            "replicas": ["0", "1"],
            "isrs": ["0", "1"]
        }
    ]
}
```

---

### СоздатьТопик

```1c
СоздатьТопик(Брокер, ИмяТопика, КоличествоПартиций, ФакторРепликации)
```

**Брокер** - Строка. Адрес брокера (например, "localhost:9092").

**ИмяТопика** - Строка. Имя создаваемого топика.

**КоличествоПартиций** - Число. Количество партиций для топика.

**ФакторРепликации** - Число. Фактор репликации (количество реплик каждой партиции).

Метод возвращает `Истина` при успешном создании топика, `Ложь` - при ошибке.
В случае ошибки текст можно получить методом `ПолучитьСообщениеОбОшибке()`.

Пример использования:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

// Опционально: установка параметров подключения
Компонента.УстановитьПараметр("security.protocol", "SASL_SSL");
Компонента.УстановитьПараметр("sasl.mechanisms", "PLAIN");
Компонента.УстановитьПараметр("sasl.username", "user");
Компонента.УстановитьПараметр("sasl.password", "password");

// Создание топика с 3 партициями и фактором репликации 2
Если Компонента.СоздатьТопик("localhost:9092", "new-topic", 3, 2) Тогда
    Сообщить("Топик успешно создан");
Иначе
    Сообщить("Ошибка создания топика: " + Компонента.ПолучитьСообщениеОбОшибке());
КонецЕсли;
```

> **Примечание:** Для создания топиков требуются соответствующие права доступа на кластере Kafka.

---

### УдалитьТопик

```1c
УдалитьТопик(Брокер, ИмяТопика)
```

**Брокер** - Строка. Адрес брокера (например, "localhost:9092").

**ИмяТопика** - Строка. Имя удаляемого топика.

Метод возвращает `Истина` при успешном удалении топика, `Ложь` - при ошибке.
В случае ошибки текст можно получить методом `ПолучитьСообщениеОбОшибке()`.

Пример использования:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

// Опционально: установка параметров подключения
Компонента.УстановитьПараметр("security.protocol", "SASL_SSL");
Компонента.УстановитьПараметр("sasl.mechanisms", "PLAIN");
Компонента.УстановитьПараметр("sasl.username", "user");
Компонента.УстановитьПараметр("sasl.password", "password");

// Удаление топика
Если Компонента.УдалитьТопик("localhost:9092", "old-topic") Тогда
    Сообщить("Топик успешно удален");
Иначе
    Сообщить("Ошибка удаления топика: " + Компонента.ПолучитьСообщениеОбОшибке());
КонецЕсли;
```

> **Внимание:** Удаление топика является необратимой операцией. Все данные в топике будут безвозвратно удалены.
> Для удаления топиков требуются соответствующие права доступа на кластере Kafka, а также параметр `delete.topic.enable=true` в конфигурации брокера.

---

### ПолучитьНастройкиТопика

```1c
ПолучитьНастройкиТопика(Брокер, ИмяТопика, Таймаут = 5000)
```

**Брокер** - Строка. Адрес брокера (например, "localhost:9092").

**ИмяТопика** - Строка. Имя топика, для которого необходимо получить настройки.

**Таймаут** - Число. Таймаут ожидания ответа в миллисекундах. По умолчанию 5000.

Метод возвращает строку JSON с конфигурацией топика.

Структура:
+ topic - Имя топика
+ configs - Массив параметров конфигурации
  + name - Имя параметра
  + value - Значение параметра
  + is_read_only - Параметр только для чтения (true/false)
  + is_default - Используется значение по умолчанию (true/false)
  + is_sensitive - Чувствительные данные, значение скрыто (true/false)
  + source - Источник значения (DYNAMIC_TOPIC_CONFIG, DEFAULT_CONFIG и др.)

Пример использования:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

// Опционально: установка параметров подключения
Компонента.УстановитьПараметр("security.protocol", "SASL_SSL");
Компонента.УстановитьПараметр("sasl.mechanisms", "PLAIN");
Компонента.УстановитьПараметр("sasl.username", "user");
Компонента.УстановитьПараметр("sasl.password", "password");

// Получение настроек топика
РезультатJSON = Компонента.ПолучитьНастройкиТопика("localhost:9092", "my-topic");

Если ПустаяСтрока(РезультатJSON) Тогда
    Сообщить("Ошибка: " + Компонента.ПолучитьСообщениеОбОшибке());
КонецЕсли;
```

Пример ответа:

```json
{
    "topic": "my-topic",
    "configs": [
        {
            "name": "retention.ms",
            "value": "604800000",
            "is_read_only": "false",
            "is_default": "true",
            "is_sensitive": "false",
            "source": "DEFAULT_CONFIG"
        },
        {
            "name": "cleanup.policy",
            "value": "delete",
            "is_read_only": "false",
            "is_default": "true",
            "is_sensitive": "false",
            "source": "DEFAULT_CONFIG"
        },
        {
            "name": "max.message.bytes",
            "value": "1048588",
            "is_read_only": "false",
            "is_default": "true",
            "is_sensitive": "false",
            "source": "DEFAULT_CONFIG"
        }
    ]
}
```

---

### УстановитьНастройкиТопика

```1c
УстановитьНастройкиТопика(Брокер, ИмяТопика, НастройкиJSON, Таймаут = 10000)
```

**Брокер** - Строка. Адрес брокера (например, "localhost:9092").

**ИмяТопика** - Строка. Имя топика, для которого необходимо изменить настройки.

**НастройкиJSON** - Строка. JSON-объект с параметрами конфигурации в формате `{"параметр": "значение"}`.

**Таймаут** - Число. Таймаут ожидания ответа в миллисекундах. По умолчанию 10000.

Метод возвращает `Истина` при успешном изменении настроек, `Ложь` - при ошибке.
В случае ошибки текст можно получить методом `ПолучитьСообщениеОбОшибке()`.

Пример использования:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

// Опционально: установка параметров подключения
Компонента.УстановитьПараметр("security.protocol", "SASL_SSL");
Компонента.УстановитьПараметр("sasl.mechanisms", "PLAIN");
Компонента.УстановитьПараметр("sasl.username", "user");
Компонента.УстановитьПараметр("sasl.password", "password");

// Изменение настроек топика
// retention.ms = 86400000 (1 день в миллисекундах)
// max.message.bytes = 2097152 (2 МБ)
НастройкиJSON = "{""retention.ms"": ""86400000"", ""max.message.bytes"": ""2097152""}";

Если Компонента.УстановитьНастройкиТопика("localhost:9092", "my-topic", НастройкиJSON) Тогда
    Сообщить("Настройки топика успешно изменены");
Иначе
    Сообщить("Ошибка изменения настроек: " + Компонента.ПолучитьСообщениеОбОшибке());
КонецЕсли;
```

Часто используемые параметры конфигурации топика:

| Параметр | Описание | Пример значения |
|----------|----------|-----------------|
| retention.ms | Время хранения сообщений (мс) | 604800000 (7 дней) |
| retention.bytes | Максимальный размер лога партиции | 1073741824 (1 ГБ) |
| max.message.bytes | Максимальный размер сообщения | 1048576 (1 МБ) |
| cleanup.policy | Политика очистки (delete/compact) | delete |
| min.insync.replicas | Минимум синхронных реплик | 2 |
| segment.bytes | Размер сегмента лога | 1073741824 (1 ГБ) |

> **Примечание:** Для изменения настроек топиков требуются соответствующие права доступа на кластере Kafka.

---

### ПолучитьОтставаниеКонсьюмера

```1c
ПолучитьОтставаниеКонсьюмера(Брокер, ИмяТопика, ГруппаКонсьюмеров, Таймаут = 5000)
```

**Брокер** - Строка. Адрес брокера (например, "localhost:9092").

**ИмяТопика** - Строка. Имя топика.

**ГруппаКонсьюмеров** - Строка. Идентификатор группы консьюмеров.

**Таймаут** - Число. Таймаут ожидания ответа в миллисекундах. По умолчанию 5000.

Метод возвращает строку JSON с информацией об отставании (lag) консьюмера.

Структура:
+ topic - Имя топика
+ consumer_group - Группа консьюмеров
+ total_lag - Суммарное отставание по всем партициям
+ partitions - Массив информации о партициях
  + partition - Номер партиции
  + low_watermark - Минимальный offset в партиции
  + high_watermark - Максимальный offset (конец лога)
  + committed_offset - Зафиксированный offset группы (или "none" если не зафиксирован)
  + lag - Отставание (high_watermark - committed_offset)

Пример использования:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

// Опционально: установка параметров подключения
Компонента.УстановитьПараметр("security.protocol", "SASL_SSL");
Компонента.УстановитьПараметр("sasl.mechanisms", "PLAIN");
Компонента.УстановитьПараметр("sasl.username", "user");
Компонента.УстановитьПараметр("sasl.password", "password");

// Получение отставания консьюмера
РезультатJSON = Компонента.ПолучитьОтставаниеКонсьюмера("localhost:9092", "my-topic", "my-consumer-group");

Если ПустаяСтрока(РезультатJSON) Тогда
    Сообщить("Ошибка: " + Компонента.ПолучитьСообщениеОбОшибке());
Иначе
    // Парсинг JSON и анализ отставания
    ЧтениеJSON = Новый ЧтениеJSON;
    ЧтениеJSON.УстановитьСтроку(РезультатJSON);
    Результат = ПрочитатьJSON(ЧтениеJSON);

    Сообщить("Общее отставание: " + Результат["total_lag"]);
КонецЕсли;
```

Пример ответа:

```json
{
    "topic": "my-topic",
    "consumer_group": "my-consumer-group",
    "total_lag": "150",
    "partitions": [
        {
            "partition": "0",
            "low_watermark": "0",
            "high_watermark": "1000",
            "committed_offset": "950",
            "lag": "50"
        },
        {
            "partition": "1",
            "low_watermark": "0",
            "high_watermark": "2000",
            "committed_offset": "1900",
            "lag": "100"
        }
    ]
}
```

> **Примечание:** Метод полезен для мониторинга состояния обработки сообщений. Большое значение lag может указывать на то, что консьюмер не успевает обрабатывать входящий поток сообщений.

---

### ПолучитьКонсьюмеровТопика

```1c
ПолучитьКонсьюмеровТопика(Брокер, ИмяТопика, Таймаут = 5000)
```

**Брокер** - Строка. Адрес брокера (например, "localhost:9092").

**ИмяТопика** - Строка. Имя топика, для которого необходимо получить список консьюмеров.

**Таймаут** - Число. Таймаут ожидания ответа в миллисекундах. По умолчанию 5000.

Метод возвращает строку JSON со списком групп консьюмеров, имеющих committed offsets для указанного топика. Метод находит группы в любом состоянии (Stable, Empty, Dead и др.).

Структура:
+ topic - Имя топика
+ groups_count - Количество найденных групп консьюмеров
+ consumer_groups - Массив информации о группах
  + group_id - Идентификатор группы консьюмеров
  + state - Состояние группы (Stable, Empty, Dead, PreparingRebalance, CompletingRebalance)
  + offsets - Массив committed offsets группы для данного топика
    + partition - Номер партиции
    + offset - Зафиксированное смещение

Пример использования:

```1c
Компонента = Новый("AddIn.SimpleKafka1C.SimpleKafka1C");

// Опционально: установка параметров подключения
Компонента.УстановитьПараметр("security.protocol", "SASL_SSL");
Компонента.УстановитьПараметр("sasl.mechanisms", "PLAIN");
Компонента.УстановитьПараметр("sasl.username", "user");
Компонента.УстановитьПараметр("sasl.password", "password");

// Получение списка консьюмеров топика
РезультатJSON = Компонента.ПолучитьКонсьюмеровТопика("localhost:9092", "my-topic");

Если ПустаяСтрока(РезультатJSON) Тогда
    Сообщить("Ошибка: " + Компонента.ПолучитьСообщениеОбОшибке());
Иначе
    // Парсинг JSON
    ЧтениеJSON = Новый ЧтениеJSON;
    ЧтениеJSON.УстановитьСтроку(РезультатJSON);
    Результат = ПрочитатьJSON(ЧтениеJSON);

    Сообщить("Найдено групп консьюмеров: " + Результат["groups_count"]);

    Для Каждого Группа Из Результат["consumer_groups"] Цикл
        Сообщить("Группа: " + Группа["group_id"] + ", состояние: " + Группа["state"]);
        Для Каждого Смещение Из Группа["offsets"] Цикл
            Сообщить("  Партиция " + Смещение["partition"] + ": offset=" + Смещение["offset"]);
        КонецЦикла;
    КонецЦикла;
КонецЕсли;
```

Пример ответа:

```json
{
    "topic": "my-topic",
    "groups_count": "2",
    "consumer_groups": [
        {
            "group_id": "my-consumer-group-1",
            "state": "Stable",
            "offsets": [
                {
                    "partition": "0",
                    "offset": "1500"
                },
                {
                    "partition": "1",
                    "offset": "2300"
                }
            ]
        },
        {
            "group_id": "my-consumer-group-2",
            "state": "Empty",
            "offsets": [
                {
                    "partition": "0",
                    "offset": "800"
                }
            ]
        }
    ]
}
```

> **Примечание:** Метод возвращает все группы консьюмеров, имеющие committed offsets для указанного топика, независимо от их текущего состояния. Это позволяет находить группы в состоянии Empty (без активных членов), которые ранее читали топик.
